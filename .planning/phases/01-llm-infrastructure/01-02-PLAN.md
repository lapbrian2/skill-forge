---
phase: 01-llm-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types.ts
  - src/lib/llm/token-tracker.ts
autonomous: true

must_haves:
  truths:
    - "Token usage is tracked per-project with task type, model, input/output tokens, cache metrics, and timestamp"
    - "Project interface includes a token_usage array for accumulating LLM call costs"
    - "Token tracker provides utility to add usage entries and calculate totals"
  artifacts:
    - path: "src/lib/types.ts"
      provides: "Updated Project interface with token_usage array and TokenUsageEntry type"
      contains: "token_usage"
    - path: "src/lib/llm/token-tracker.ts"
      provides: "Token tracking utilities for accumulating and summarizing LLM usage per project"
      exports: ["addTokenUsage", "getTokenTotals", "TokenUsageEntry", "TokenTotals"]
  key_links:
    - from: "src/lib/llm/token-tracker.ts"
      to: "src/lib/types.ts"
      via: "imports Project and TokenUsageEntry types"
      pattern: "import.*from.*types"
---

<objective>
Add token usage tracking infrastructure to the data model and create utilities for accumulating and summarizing LLM costs per project.

Purpose: Requirement LLM-06 mandates token usage tracked and displayed per project. This plan adds the data structures and utility functions. The API routes (Plan 03) will use these to record usage after each LLM call, and the frontend will display totals.
Output: Updated Project type with token_usage field, new token-tracker.ts with add/summarize utilities
</objective>

<execution_context>
@C:/Users/Brian/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Brian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-llm-infrastructure/01-RESEARCH.md

@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add token usage types to Project interface</name>
  <files>src/lib/types.ts</files>
  <action>
Add a new `TokenUsageEntry` interface and update the `Project` interface to include token tracking.

1. Add `TokenUsageEntry` interface in a new section "── Token Usage ──" (following the codebase's section header pattern):
   ```
   interface TokenUsageEntry {
     task: string;           // e.g., "classify", "question", "generate"
     model: string;          // e.g., "claude-haiku-4-5"
     input_tokens: number;
     output_tokens: number;
     cache_read_input_tokens: number;
     cache_creation_input_tokens: number;
     timestamp: string;      // ISO 8601
   }
   ```

2. Add `token_usage: TokenUsageEntry[]` field to the `Project` interface, after the `validation` field.

3. Update the `createProject()` factory function to initialize `token_usage: []` in the returned object.

Do NOT change any other fields or types. The existing code must continue to work. Existing projects in localStorage that lack `token_usage` will need a fallback -- add a comment noting this: "// NOTE: Existing localStorage projects may lack token_usage. Consumers should default to []"

Export `TokenUsageEntry` as a named export.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Verify zero errors. Check that Project interface now includes token_usage field and createProject returns it initialized to [].
  </verify>
  <done>
Project interface has token_usage: TokenUsageEntry[] field. createProject() initializes it to []. TokenUsageEntry type is exported. All existing code compiles without changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create token tracking utilities</name>
  <files>src/lib/llm/token-tracker.ts</files>
  <action>
Create `src/lib/llm/token-tracker.ts` with utility functions for token usage tracking.

1. Define `TokenTotals` interface:
   ```
   interface TokenTotals {
     total_input_tokens: number;
     total_output_tokens: number;
     total_cache_read_tokens: number;
     total_cache_creation_tokens: number;
     total_calls: number;
     by_task: Record<string, { input: number; output: number; calls: number }>;
     by_model: Record<string, { input: number; output: number; calls: number }>;
   }
   ```

2. `createTokenUsageEntry(task: string, model: string, usage: { input_tokens: number, output_tokens: number, cache_read_input_tokens?: number, cache_creation_input_tokens?: number }): TokenUsageEntry`
   - Creates a TokenUsageEntry with current ISO timestamp
   - Defaults cache fields to 0 if not provided
   - Import TokenUsageEntry from "@/lib/types"

3. `addTokenUsage(project: Project, entry: TokenUsageEntry): Project`
   - Returns a NEW Project object (immutable pattern) with the entry appended to token_usage
   - Also updates `updated_at` timestamp
   - Handles case where project.token_usage is undefined (legacy projects) by defaulting to []
   - Import Project from "@/lib/types"

4. `getTokenTotals(entries: TokenUsageEntry[]): TokenTotals`
   - Sums all token counts across entries
   - Groups by task type and by model
   - Returns the TokenTotals object

5. `estimateCost(entries: TokenUsageEntry[]): { input_cost: number, output_cost: number, cache_savings: number, total_cost: number }`
   - Rough cost estimation based on current Anthropic pricing (as of 2025):
     - Haiku: $0.80/MTok input, $4.00/MTok output
     - Sonnet: $3.00/MTok input, $15.00/MTok output
     - Cache read: 90% discount on input price
     - Cache creation: 25% premium on input price
   - Returns costs in USD
   - Add comment noting these are estimates and may need updating

Follow codebase conventions: section header with decorative divider at top, named exports, camelCase function names.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Verify zero errors. Check that token-tracker.ts exports createTokenUsageEntry, addTokenUsage, getTokenTotals, estimateCost.
  </verify>
  <done>
token-tracker.ts provides complete token tracking infrastructure: creating entries, adding to projects (immutably), summarizing totals by task/model, and estimating costs. All functions typed and exported. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/lib/types.ts` has TokenUsageEntry interface and Project.token_usage field
3. `src/lib/llm/token-tracker.ts` exists with 4 exported utility functions
4. createProject() returns token_usage: []
5. No existing functionality broken
</verification>

<success_criteria>
- Project interface includes token_usage: TokenUsageEntry[] with all required fields
- createProject() initializes token_usage to empty array
- addTokenUsage returns new Project object (immutable)
- getTokenTotals correctly aggregates by task and model
- estimateCost provides reasonable USD estimates for Haiku and Sonnet models
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-llm-infrastructure/01-02-SUMMARY.md`
</output>
